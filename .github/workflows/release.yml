name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true

      - name: Update Major Tag
        uses: actions/github-script@v7
        with:
          script: |
            const tagName = context.ref.replace('refs/tags/', '');
            // Check if tag matches v1.2.3 format
            if (!tagName.match(/^v\d+\.\d+\.\d+$/)) {
              console.log('Tag does not match semantic versioning (vX.Y.Z), skipping major tag update.');
              return;
            }
            
            const majorVersion = tagName.split('.')[0]; // e.g., v1
            
            console.log(`Updating ${majorVersion} to point to ${tagName} (${context.sha})`);
            
            try {
              // Try to update existing tag
              await github.rest.git.updateRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${majorVersion}`,
                sha: context.sha,
                force: true
              });
              console.log(`Updated ${majorVersion}`);
            } catch (e) {
              console.log(`Update failed, trying to create ${majorVersion}. Error: ${e.message}`);
              // If tag doesn't exist (404) or other error, try creating it
              try {
                await github.rest.git.createRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `refs/tags/${majorVersion}`,
                  sha: context.sha
                });
                console.log(`Created ${majorVersion}`);
              } catch (createError) {
                console.log(`Failed to create ref: ${createError.message}`);
                // If it failed because it already exists (race condition or previous error was misleading), fail the step
                throw createError;
              }
            }
